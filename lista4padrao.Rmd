---
title: "Lista 4: Teoria de Vis"
author: "Insira seu nome aqui"
date: "05/05/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE,
                      fig.retina = 2,
                      tidy.opts=list(width.cutoff = 120),
                      options(width = 120))
library(tidyverse)
library(lubridate)
library(ggmap)
library(ggrepel)
library(gridExtra)
library(pander)
```

# Problema 1: The Economist

Crie o último gráfico do link https://tutorials.iq.harvard.edu/R/Rgraphics/Rgraphics.html. Este é um gráfico que apresenta uma relação entre o IDH x IPC entre diversos países.

**Resposta:**

```{r}

```

# Problema 2: Minard

Reproduza o gráfico de Minard que representa a jornada do lider político Napoleão ao levar seu exército para a Campanha Russa. O tutorial se encontra em [https://www.andrewheiss.com/blog/2017/08/10/exploring-minards-1812-plot-with-ggplot2/].

**Resposta:**

Começamos importando os dados baixados e já transformando as datas para o formato padrão do R.

```{r}
cities <- read.table("./2/cities.txt",
                     header = TRUE, stringsAsFactors = FALSE)

troops <- read.table("./2/troops.txt",
                     header = TRUE, stringsAsFactors = FALSE)

temps <- read.table("./2/temps.txt",
                    header = TRUE, stringsAsFactors = FALSE) %>%
  mutate(date = dmy(date))
```

Vamos começar com o gráfico de cima. Dentro da variável `troops` armazenamos os dados relativos ao caminhos traçados por cada grupo. Plotando esses caminhos com o `geom_path()`:

```{r,fig.width=10, fig.height=2.5}
ggplot(troops, aes(x = long, y = lat, group = group)) +
  geom_path()
```

Plotando agora com o diferenciando a quantidade de sobreviventes pela espessura da linha e a direção pela cor:

```{r, fig.width=10, fig.height=2.5}
ggplot(troops, aes(x = long, y = lat, group = group, 
                   color = direction, size = survivors)) +
  geom_path(lineend = "round")
```

Vamos usar o `scale_size()` para transmitir melhor a quantidade de sobreviventes: 

```{r, fig.width=10, fig.height=2.5}
ggplot(troops, aes(x = long, y = lat, group = group, 
                   color = direction, size = survivors)) +
  geom_path(lineend = "round") +
  scale_size(range = c(0.5, 15))
```

Vamos remover a legendas e mudar as cores:

```{r, fig.width=10, fig.height=2.5}
ggplot(troops, aes(x = long, y = lat, group = group, 
                   color = direction, size = survivors)) +
  geom_path(lineend = "round") +
  scale_size(range = c(0.5, 15)) + 
  scale_colour_manual(values = c("#DFC17E", "#252523")) +
  labs(x = NULL, y = NULL) + 
  guides(color = FALSE, size = FALSE)
```

Vamos então adicionar as cidades nas quais as tropas passaram no gráfico com o `geom_point()`:

```{r, fig.width=10, fig.height=2.5}
ggplot() +
  geom_path(data = troops, aes(x = long, y = lat, group = group, 
                               color = direction, size = survivors),
            lineend = "round") +
  geom_point(data = cities, aes(x = long, y = lat)) +
  geom_text(data = cities, aes(x = long, y = lat, label = city), vjust = 1.5) +
  scale_size(range = c(0.5, 15)) + 
  scale_colour_manual(values = c("#DFC17E", "#252523")) +
  labs(x = NULL, y = NULL) + 
  guides(color = FALSE, size = FALSE)
```

Como os nomes de algumas das cidades ficou em cima da linha preta, vamos utilizar o `geom_textrepel()` para resolver esse problema:

```{r, fig.width=10, fig.height=2.5, warning=FALSE}
ggplot() +
  geom_path(data = troops, aes(x = long, y = lat, group = group, 
                               color = direction, size = survivors),
            lineend = "round") +
  geom_point(data = cities, aes(x = long, y = lat),
             color = "#DC5B44") +
  geom_text_repel(data = cities, aes(x = long, y = lat, label = city),
                  color = "#DC5B44", family = "Open Sans Condensed Bold") +
  scale_size(range = c(0.5, 15)) + 
  scale_colour_manual(values = c("#DFC17E", "#252523")) +
  labs(x = NULL, y = NULL) + 
  guides(color = FALSE, size = FALSE)
```

Vamos agora começar o processo de adicionar um mapa no gráfico, para isso temos que baixar a imagem de fundo:

```{r, message=FALSE}
march.1812.europe <- c(left = -13.10, bottom = 35.75, right = 41.04, top = 61.86)
march.1812.europe.map <- get_stamenmap(bbox = march.1812.europe, zoom = 5,
                                       maptype = "terrain", where = "cache")
march.1812.europe.map.wc <- get_stamenmap(bbox = march.1812.europe, zoom = 5,
                                          maptype = "watercolor", where = "cache")
```

Usando `ggmap` vamos adicionar o mapa de fundo: 

```{r, fig.width=10, fig.height=6}
ggmap(march.1812.europe.map.wc) +
  geom_path(data = troops, aes(x = long, y = lat, group = group, 
                               color = direction, size = survivors),
            lineend = "round") +
  scale_size(range = c(0.5, 5)) + 
  scale_colour_manual(values = c("#DFC17E", "#252523")) +
  guides(color = FALSE, size = FALSE) +
  theme_nothing()
```

Vamos agora dar um zoom no mapa para a região que queremos e então adicionar o resto dos elementos que já tinhamos:

```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=4}
march.1812.ne.europe <- c(left = 23.5, bottom = 53.4, right = 38.1, top = 56.3)

march.1812.ne.europe.map <- get_stamenmap(bbox = march.1812.ne.europe, zoom = 8,
                                          maptype = "terrain-background", where = "cache")

march.1812.plot <- ggmap(march.1812.ne.europe.map) +
  geom_path(data = troops, aes(x = long, y = lat, group = group, 
                               color = direction, size = survivors),
            lineend = "round") +
  geom_point(data = cities, aes(x = long, y = lat),
             color = "#DC5B44") +
  geom_text_repel(data = cities, aes(x = long, y = lat, label = city),
                  color = "#DC5B44", family = "Open Sans Condensed Bold") +
  scale_size(range = c(0.5, 10)) + 
  scale_colour_manual(values = c("#DFC17E", "#252523")) +
  guides(color = FALSE, size = FALSE) +
  theme_nothing()

march.1812.plot
```

Temos então a parte superior do gráfico final, vamos ao gráfico de temperaturas.

Podemos facilmente gerá-lo com `geom_line()`:

```{r, fig.width=10, fig.height=4}
ggplot(data = temps, aes(x = long, y = temp)) +
  geom_line() +
  geom_text(aes(label = temp), vjust = 1.5)
```

Melhorando as labels, removendo o grid vertical, movendo o eixo y para a direita e removendo as descrições do eixo x:

```{r, fig.width=10, fig.height=4, warning=FALSE}
temps.nice <- temps %>%
  mutate(nice.label = paste0(temp, "°, ", month, ". ", day))

temps.1812.plot <- ggplot(data = temps.nice, aes(x = long, y = temp)) +
  geom_line() +
  geom_label(aes(label = nice.label),
            family = "Open Sans Condensed Bold", size = 2.5) + 
  labs(x = NULL, y = "° Celsius") +
  scale_x_continuous(limits = ggplot_build(march.1812.plot)$layout$panel_ranges[[1]]$x.range) +
  scale_y_continuous(position = "right") +
  coord_cartesian(ylim = c(-35, 5)) +  # Add some space above/below
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(), axis.ticks = element_blank(),
        panel.border = element_blank())

temps.1812.plot
```

Tendo o gráfico de temperatura, vamos juntar os gráficos com `grid`:

```{r, warning=FALSE}
both.1812.plot <- rbind(ggplotGrob(march.1812.plot),
                        ggplotGrob(temps.1812.plot))

grid::grid.newpage()
grid::grid.draw(both.1812.plot)
```

Os gráficos estão alinhados mas temos um problema com as proporções. Vamos resolver modificando manualmente os painéis.

```{r, fig.width=10, fig.height=5.5, warning=FALSE}
# Identificando os paneis do gráfico
panels <- both.1812.plot$layout$t[grep("panel", both.1812.plot$layout$name)]

map.panel.height <- both.1812.plot$heights[panels][1]

#Tive um problema convertendo o valor, então fiz o input manual.
map.panel.height <- list(0.345197879241894)

# Colocando os painéis no gráfico.
both.1812.plot$heights[panels] <- unit(c(map.panel.height, 0.1), "null")

grid::grid.newpage()
grid::grid.draw(both.1812.plot)
```

Vamos gerar agora um gráfico sem o mapa de fundo.

```{r, fig.width=10, fig.height=4.75, warning=FALSE}

march.1812.plot.simple <- ggplot() +
  geom_path(data = troops, aes(x = long, y = lat, group = group, 
                               color = direction, size = survivors),
            lineend = "round") +
  geom_point(data = cities, aes(x = long, y = lat),
             color = "#DC5B44") +
  geom_text_repel(data = cities, aes(x = long, y = lat, label = city),
                  color = "#DC5B44", family = "Open Sans Condensed Bold") +
  scale_size(range = c(0.5, 10)) + 
  scale_colour_manual(values = c("#DFC17E", "#252523")) +
  guides(color = FALSE, size = FALSE) +
  theme_nothing()

# Mudanças para que os eixos se coincidam sem o mapa.
temps.1812.plot <- ggplot(data = temps.nice, aes(x = long, y = temp)) +
  geom_line() +
  geom_label(aes(label = nice.label),
            family = "Open Sans Condensed Bold", size = 2.5) + 
  labs(x = NULL, y = "° Celsius") +
  scale_x_continuous(limits = ggplot_build(march.1812.plot.simple)$layout$panel_ranges[[1]]$x.range) +
  scale_y_continuous(position = "right") +
  coord_cartesian(ylim = c(-35, 5)) +  # Add some space above/below
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(), axis.ticks = element_blank(),
        panel.border = element_blank())

# Juntando os gráficos.
both.1812.plot.simple <- rbind(ggplotGrob(march.1812.plot.simple),
                               ggplotGrob(temps.1812.plot))

# Arrumando novamente a distribuição dos painéis.
panels <- both.1812.plot.simple$layout$t[grep("panel", both.1812.plot.simple$layout$name)]

both.1812.plot.simple$heights[panels] <- unit(c(3, 1), "null")

grid::grid.newpage()
grid::grid.draw(both.1812.plot.simple)
```

Pronto! 

# Problema 3: Gapminder

Faça a animação presente em https://towardsdatascience.com/how-to-build-animated-charts-like-hans-rosling-doing-it-all-in-r-570efc6ba382 seguindo os passos lá descritos.

**Resposta:**

Vamos começar lendo os dados baixados.

# Problema 4: Atirei o pau no gráfico

Assista o vídeo https://www.youtube.com/watch?v=CJkzf4IZRuk em que o autor realiza um gráfico em Excel. Seguindo os mesmos passos, faça esse gráfico em R.

**Resposta:**

```{r}

```

